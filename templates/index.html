<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Loan Repayment Prediction</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
<div class="container">
    <h2>Loan Repayment Prediction</h2>

    <form id="predict-form" method="POST">
        <div class="grid">
            <input type="number" name="age" placeholder="Age" required>

            <select name="gender" required>
                <option value="" disabled selected>Select gender</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
            </select>
            <select name="marital_status" required>
                <option value="" disabled selected>Select marital status</option>
                <option value="Married">Married</option>
                <option value="Single">Single</option>
                <option value="Divorced">Divorced</option>
                <option value="Widowed">Widowed</option>
            </select>
            <select name="education_level" required>
                <option value="" disabled selected>Select education level</option>
                <option value="Master's">Master's</option>
                <option value="Bachelor's">Bachelor's</option>
                <option value="High School">High School</option>
                <option value="PhD">PhD</option>
                <option value="Other">Other</option>
                
            </select>
            <select name="employment_status" required>
                <option value="" disabled selected>Select employment status</option>
                <option value="Employed">Employed</option>
                <option value="Unemployed">Unemployed</option>
                <option value="Self-employed">Self-employed</option>
                <option value="Student">Student</option>
                <option value="Retired">Retired</option>
            </select>
            <select name="loan_purpose" required>
                <option value="" disabled selected>Select loan purpose</option>
                <option value="Car">Car</option>
                <option value="Debt consolidation">Debt consolidation</option>
                <option value="Business">Business</option>
                <option value="Other">Other</option>
                <option value="Home">Home</option>
                <option value="Medical">Medical</option>
                <option value="Education">Education</option>
                <option value="Vacation">Vacation</option>
            </select>
            <select name="grade_subgrade" required>
                <option value="" disabled selected>Select grade subgrade</option>
                <option value="A1">A1</option>
                <option value="A2">A2</option>
                <option value="A3">A3</option>
                <option value="A4">A4</option>
                <option value="A5">A5</option>
                <option value="B1">B1</option>
                <option value="B2">B2</option>
                <option value="B3">B3</option>
                <option value="B4">B4</option>
                <option value="B5">B5</option>
                <option value="C1">C1</option>
                <option value="C2">C2</option>
                <option value="C3">C3</option>
                <option value="C4">C4</option>
                <option value="C5">C5</option>
                <option value="D1">D1</option>
                <option value="D2">D2</option>
                <option value="D3">D3</option>
                <option value="D4">D4</option>
                <option value="D5">D5</option>
                <option value="E1">E1</option>
                <option value="E2">E2</option>
                <option value="E3">E3</option>
                <option value="E4">E4</option>
                <option value="E5">E5</option>
                <option value="F1">F1</option>
                <option value="F2">F2</option>
                <option value="F3">F3</option>
                <option value="F4">F4</option>
                <option value="F5">F5</option>
            </select>

            <input type="number" step="any" name="annual_income" placeholder="Annual Income" required>
            <input type="number" step="any" name="monthly_income" placeholder="Monthly Income" required>
            <input type="number" step="any" name="debt_to_income_ratio" placeholder="Debt to Income Ratio" required>
            <input type="number" name="credit_score" placeholder="Credit Score" required>
            <input type="number" step="any" name="loan_amount" placeholder="Loan Amount" required>
            <input type="number" step="any" name="interest_rate" placeholder="Interest Rate" required>
            <input type="number" name="loan_term" placeholder="Loan Term (months)" required>
            <input type="number" step="any" name="installment" placeholder="Installment" required>
            <input type="number" name="num_of_open_accounts" placeholder="Open Accounts" required>
            <input type="number" step="any" name="total_credit_limit" placeholder="Total Credit Limit" required>
            <input type="number" step="any" name="current_balance" placeholder="Current Balance" required>
            <input type="number" name="delinquency_history" placeholder="Delinquency History" required>
            <input type="number" name="public_records" placeholder="Public Records" required>
            <input type="number" name="num_of_delinquencies" placeholder="Number of Delinquencies" required>
        </div>

        <button type="submit">Predict</button>
    </form>

    <div id="client-result" style="margin-top:20px;"></div>

    <div id="network-log" style="margin-top:20px; font-family:monospace; font-size:13px; color:#333;"></div>

    {% if prediction %}
        <div class="result">
            <h3>Prediction Result</h3>
            <p><strong>Status:</strong> {{ prediction }}</p>
            <p><strong>Probability:</strong> {{ probability }}</p>
        </div>
    {% endif %}

    {% if error %}
        <div class="error">
            <p>{{ error }}</p>
        </div>
    {% endif %}

    <script>
        // Intercept the form submit and send via fetch so we can inspect network programmatically
        const form = document.getElementById('predict-form');
        const logEl = document.getElementById('network-log');
        const resultEl = document.getElementById('client-result');

        function appendLog(msg) {
            const p = document.createElement('div');
            p.textContent = msg;
            logEl.prepend(p);
        }

        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            resultEl.innerHTML = '';
            appendLog('Form submit intercepted â€” preparing request');

            const formData = new FormData(form);
            const obj = {};
            for (const [k, v] of formData.entries()) obj[k] = v;

            appendLog('Sending POST to frontend / (AJAX)');

            try {
                const resp = await fetch(window.location.pathname, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Accept': 'application/json'
                    },
                    body: formData
                });

                appendLog(`Frontend responded ${resp.status} ${resp.statusText}`);

                let data;
                const contentType = resp.headers.get('content-type') || '';
                if (contentType.includes('application/json')) {
                    data = await resp.json();
                    appendLog('Parsed JSON response');
                } else {
                    data = await resp.text();
                    appendLog('Received non-JSON response');
                }

                if (resp.ok && data && data.prediction) {
                    resultEl.innerHTML = `<div class="result"><h3>Prediction Result</h3><p><strong>Status:</strong> ${data.prediction}</p><p><strong>Probability:</strong> ${data.probability}</p></div>`;
                } else {
                    resultEl.innerHTML = `<div class="error"><pre>${JSON.stringify(data, null, 2)}</pre></div>`;
                }
            } catch (err) {
                appendLog('Fetch failed: ' + err);
                resultEl.innerHTML = `<div class="error">Fetch failed: ${err}</div>`;
            }
        });
    </script>
</div>
</body>
</html>
